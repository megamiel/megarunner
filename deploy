import subprocess
import random
import string
import sys

def generate_random_string(length=8):
    """æŒ‡å®šã•ã‚ŒãŸé•·ã•ã®ãƒ©ãƒ³ãƒ€ãƒ ãªè‹±æ•°å­—ã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹"""
    letters_and_digits = string.ascii_letters + string.digits
    return ''.join(random.choice(letters_and_digits) for i in range(length))

def run_command(command):
    """ã‚·ã‚§ãƒ«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ãã®å‡ºåŠ›ã‚’è¡¨ç¤ºã™ã‚‹"""
    print(f"\n> å®Ÿè¡Œä¸­: {' '.join(command)}")
    try:
        # ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹ (check=True)
        result = subprocess.run(
            command, 
            check=True, 
            capture_output=True, 
            text=True, 
            encoding='utf-8',
            errors='replace' # æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
        )
        print("--- æˆåŠŸ ---")
        if result.stdout:
            print(result.stdout)
        if result.stderr:
            print(result.stderr)
        return True
    except FileNotFoundError:
        print(f"ã‚¨ãƒ©ãƒ¼: ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: '{command[0]}'")
        print("GitãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã€PATHãŒé€šã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        return False
    except subprocess.CalledProcessError as e:
        print("--- ã‚¨ãƒ©ãƒ¼ ---")
        # ä½•ã‚‚ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã‚‚ã®ãŒãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ã¯ã€ç„¡è¦–ã—ã¦æˆåŠŸã¨ã¿ãªã™
        if "nothing to commit, working tree clean" in e.stdout or "ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“" in e.stdout:
            print("ã‚³ãƒŸãƒƒãƒˆã™ã‚‹æ–°ã—ã„å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
            return True # æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚€ãŸã‚ã«Trueã‚’è¿”ã™
        
        print(f"ã‚³ãƒãƒ³ãƒ‰ '{' '.join(command)}' ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
        print(f"ãƒªã‚¿ãƒ¼ãƒ³ã‚³ãƒ¼ãƒ‰: {e.returncode}")
        if e.stdout:
            print(f"Stdout:\n{e.stdout}")
        if e.stderr:
            print(f"Stderr:\n{e.stderr}")
        return False

def git_deploy():
    """git add, commit, pushã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’è‡ªå‹•åŒ–ã™ã‚‹"""
    
    # 1. git add .
    if not run_command(["git", "add", "."]):
        return

    # 2. git commit -m "{ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ}"
    commit_message = f"Auto-commit: {generate_random_string()}"
    
    # â˜…â˜…â˜… ã“ã“ãŒå¤‰æ›´ç‚¹ã§ã™ â˜…â˜…â˜…
    print(f"ğŸ“ è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: \"{commit_message}\"")
    
    if not run_command(["git", "commit", "-m", commit_message]):
        # 'nothing to commit' ã®å ´åˆã¯run_commandãŒTrueã‚’è¿”ã™ã®ã§ã€
        # ã“ã“ã§å‡¦ç†ãŒæ­¢ã¾ã‚‹ã®ã¯ã€ãã‚Œä»¥å¤–ã®ã‚³ãƒŸãƒƒãƒˆã‚¨ãƒ©ãƒ¼ã®å ´åˆ
        print("\nã‚³ãƒŸãƒƒãƒˆã«å¤±æ•—ã—ãŸãŸã‚ã€ãƒ—ãƒƒã‚·ãƒ¥ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚")
        return
        
    # 3. git push origin master
    if not run_command(["git", "push", "origin", "master"]):
        return
        
    print("\nâœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼")
    print("Vercelã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã®é€²æ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

if __name__ == "__main__":
    print("Gitãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™...")
    git_deploy()

